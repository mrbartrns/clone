<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script</title>
</head>
<body>
    <style>
        textarea {
            font-family: 'Malgun Gothic';
        }
        
        button {
            border: none;
            background: none;
            outline: none;
            color: steelblue;
            border-radius: 0;
        }

        button:hover {
            background-color: steelblue;
            color: white;
        }
        .selected {
            background-color: steelblue;
            color: white;
        }

        .row {
            float: left;
        }
    </style>
    <h1>script</h1>
    <button type="button" class="button dialog mode selected" data-type="dialog">dialog</button>
    <button type="button" class="button sfx mode" data-type="sfx">sfx</button>
    <div class="container">
        <div class="row">
            <input type="checkbox" value="selected">
        </div>
        <form class="script-form">
            <textarea class="script" rows="30" cols="100" placeholder="'캐릭터이름: 대화' 양식을 꼭 지켜주세요."></textarea>
        </form>
    </div>
    <button type="button" class="script-submit">Submit</button>
    <div class="showing">
        <p></p>
    </div>
    <!--<script src="./script.js"></script>-->
    <script>
        // strings arr랑 objarr랑 갯수를 맞추기
        const scriptInput = document.querySelector(".script");
        const showing = document.querySelector(".showing");
        const showingP = showing.querySelector("p");
        const modes = document.querySelectorAll(".mode");
        const ENTER = 13;
        const BACKSPACE = 8;
        const SELECTED = "selected";
        const action = document.querySelector(`.${SELECTED}`).dataset.type;
        
        let dialogObjects = [];
        // let strings = [];
        // let stringsLength = strings.length;
        let stringsLength = 0;

        function Dialog(action) {
            this.row = dialogObjects.length + 1;
            this.action = action;
            this.script = "";
        }

        Dialog.prototype.getRow = function() {
            return this.row;
        }

        Dialog.prototype.getAction = function() {
            return this.action;
        }

        Dialog.prototype.getScript = function() {
            return this.script;
        }

        Dialog.prototype.setRow = function(row) {
            this.row = row;
        }

        Dialog.prototype.setAction = function(action) {
            this.action = action;
        }

        Dialog.prototype.setScript = function(text) {
            this.script = text;
        }

        function refreshDialogs(strings) {
            dialogObjects.forEach((object,index) => {
                object.setRow(index + 1);
                object.setScript(strings[index]);
            })
        }

        function getTextArr() {
            const value = scriptInput.value;
            const strings = value.split("\n");
            return strings;
        }

        function getRow(textarea) {
            const txts = textarea.value;
            const txtsArr = txts.split("\n");
            const cursorPoint = textarea.selectionStart;
            let lineStart = 0;
            for (let i = 0; i < txtsArr.length; i++) {
                let lineEnd = lineStart + txtsArr[i].length + 1;
                if (lineStart <= cursorPoint && cursorPoint < lineEnd) {
                    const lineIndex = i + 1;
                    return lineIndex;
                } else {
                    lineStart = lineEnd;
                }
            }
        }

        function handleEnter() {
            const strings = getTextArr();
            const action = document.querySelector(`.${SELECTED}`).dataset.type;
            console.log(strings);
            const row = getRow(scriptInput);
            const dialogObject = new Dialog(action);
            dialogObjects.splice(row - 1, 0, dialogObject);
            console.log(dialogObjects);
            refreshDialogs();
            stringsLength = strings.length;
        }

        function handleBackSpace() {
            const strings = getTextArr();
            // const value = scriptInput.value;
            const row = getRow(scriptInput);
            // strings = value.split("\n");
            let currentLength = strings.length;
            let lengths = stringsLength - currentLength;
            if (lengths > 0) {
                dialogObjects.splice(row, lengths);
                stringsLength = currentLength;
                refreshDialogs();
                console.log(dialogObjects);
            }
        }

        // todo: modify setUpMode when I select row showing action
        function setUpMode() {
            modes[0].classList.remove(SELECTED);
            modes[1].classList.remove(SELECTED);
            this.classList.add(SELECTED);
            dialogObjects[dialogObjects.length - 1].setAction(action);
            console.log(dialogObjects);
        }

        function init() {            
            const dialogObject = new Dialog(action);
            dialogObjects.push(dialogObject);

            modes.forEach( mode => {
                mode.addEventListener("click", setUpMode);
            });

            scriptInput.addEventListener("keyup", function(e) {
                if (e.keyCode === ENTER) {
                    handleEnter();
                } else if (e.keyCode === BACKSPACE) {
                    handleBackSpace();
                }
            });

            //toDo: scriptInput.addEventListener("click", handleClick);
            scriptInput.addEventListener("click", function() {
                const row = getRow(scriptInput);
                console.log(row);
            })
        }

        init();
    </script>
</body>
</html>